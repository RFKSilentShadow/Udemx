- name: Disable traefik in k3s config
  ansible.builtin.copy:
    dest: /etc/rancher/k3s/config.yaml
    content: |
      disable:
        - traefik
  become: true

- name: Restart k3s
  ansible.builtin.systemd:
    name: k3s
    state: restarted
  become: true

- name: Wait for node ready
  ansible.builtin.shell: |
    kubectl wait --for=condition=Ready node --all --timeout=120s
  environment:
    KUBECONFIG: /opt/udemx/.kube/config

- name: Add ingress-nginx repo
  ansible.builtin.shell: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
  register: add_repo
  changed_when: add_repo.rc == 0 and "already exists" not in add_repo.stdout

- name: Update helm repos
  ansible.builtin.shell: helm repo update
  when: add_repo.changed

- name: Install ingress controller
  ansible.builtin.shell: >
    helm upgrade --install {{ ingress_release }} ingress-nginx/ingress-nginx
    --namespace {{ nginx_namespace }}
    --create-namespace
    --set controller.publishService.enabled=true
    --set controller.ingressClassResource.default=true
  environment:
    KUBECONFIG: /opt/udemx/.kube/config

- name: Wait for nginx ingress controller
  ansible.builtin.shell: |
    kubectl -n {{ nginx_namespace }} rollout status deployment/{{ ingress_release }}-ingress-nginx-controller --timeout=120s
  environment:
    KUBECONFIG: /opt/udemx/.kube/config

- name: Generate self-signed cert files
  ansible.builtin.shell: |
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
      -keyout /tmp/udemx.key -out /tmp/udemx.crt \
      -subj "/CN=udemx.local/O=udemx"
  args:
    creates: /tmp/udemx.crt

- name: Create self-signed cert (k8s secret)
  ansible.builtin.shell: |
    kubectl -n {{ nginx_namespace }} create secret tls udemx-tls \
      --cert=/tmp/udemx.crt --key=/tmp/udemx.key --dry-run=client -o yaml | kubectl apply -f -

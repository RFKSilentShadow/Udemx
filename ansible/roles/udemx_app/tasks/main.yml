#- name: Add stable repo (example)
#  ansible.builtin.command: helm repo add stable https://charts.helm.sh/stable

- name: Deploy demo app (simple nginx with message)
  ansible.builtin.shell: |
    cat <<'EOF' > /tmp/udemx-index.html
    <html><body><h1>Hello UDEMX!</h1></body></html>
    EOF

    kubectl -n {{ app_namespace }} create configmap udemx-index --from-file=index.html=/tmp/udemx-index.html --dry-run=client -o yaml | kubectl apply -f -

    cat <<'EOF' > /tmp/udemx-deploy.yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: udemx-web
      labels:
        app: udemx-web
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: udemx-web
      template:
        metadata:
          labels:
            app: udemx-web
        spec:
          containers:
          - name: nginx
            image: nginx:1.25-alpine
            ports:
            - containerPort: 80
            volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html/index.html
              subPath: index.html
          volumes:
          - name: html
            configMap:
              name: udemx-index
    EOF

    kubectl -n {{ app_namespace }} apply -f /tmp/udemx-deploy.yaml

    cat <<'EOF' > /tmp/udemx-svc.yaml
    apiVersion: v1
    kind: Service
    metadata:
      name: udemx-web
    spec:
      selector:
        app: udemx-web
      ports:
        - protocol: TCP
          port: 80
          targetPort: 80
    EOF
    kubectl -n {{ app_namespace }} apply -f /tmp/udemx-svc.yaml

    cat <<'EOF' > /tmp/udemx-ingress.yaml
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: udemx-ingress
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
    spec:
      tls:
      - hosts:
        - udemx.local
        secretName: udemx-tls
      rules:
      - host: udemx.local
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: udemx-web
                port:
                  number: 80
    EOF
    kubectl -n {{ app_namespace }} apply -f /tmp/udemx-ingress.yaml
